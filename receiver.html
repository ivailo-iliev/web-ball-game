<!doctype html>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>One-bit P2P demo</title>

<h3 id=state>Connecting…</h3>
<button id=btn0 disabled>Send 0</button>
<button id=btn1 disabled>Send 1</button>

<script>
const $ = id => document.getElementById(id);
const log = t => $('#state').textContent = t;

// ---- 1. Connect to signalling server ----
const ws = new WebSocket('ws://192.168.0.42:8080');   // ← change to your server’s LAN IP
ws.onopen = () => log('Waiting for peer…');
ws.onmessage = async ev => {
  const msg = JSON.parse(ev.data);
  if (msg.type === 'role') {
    startWebRTC(msg.role);
  } else {
    // any other message is a signalling blob from partner
    await handleSignal(msg);
  }
};

// ---- 2. WebRTC setup ----
const pc = new RTCPeerConnection({iceServers: []});
let dc;   // datachannel
pc.onicecandidate = e => e.candidate && send({type:'candidate',candidate:e.candidate});

async function startWebRTC(role) {
  if (role === 'offerer') {
    dc = pc.createDataChannel('bit',{ordered:false,maxRetransmits:0});
    dc.onopen = channelOpen;
    dc.onmessage = e => alert('Received: '+e.data);
    await pc.setLocalDescription(await pc.createOffer());
    send({type:'offer',sdp: pc.localDescription});
  } else {
    pc.ondatachannel = e => {
      dc = e.channel;
      dc.onopen = channelOpen;
      dc.onmessage = e => alert('Received: '+e.data);
    };
  }
}

async function handleSignal({type,sdp,candidate}) {
  if (type === 'offer') {
    await pc.setRemoteDescription(sdp);
    await pc.setLocalDescription(await pc.createAnswer());
    send({type:'answer',sdp: pc.localDescription});
  } else if (type === 'answer') {
    await pc.setRemoteDescription(sdp);
  } else if (type === 'candidate') {
    try { await pc.addIceCandidate(candidate); } catch{}
  }
}

function send(obj){ ws.send(JSON.stringify(obj)); }

function channelOpen() {
  log('Channel open! Tap a button.');
  $('#btn0').disabled = $('#btn1').disabled = false;
}

// ---- 3. Buttons to send the bit ----
$('#btn0').onclick = () => dc.readyState==='open' && dc.send('0');
$('#btn1').onclick = () => dc.readyState==='open' && dc.send('1');
</script>
